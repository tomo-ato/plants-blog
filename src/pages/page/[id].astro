---
import { parseScrapboxContent } from '../../utils/scrapbox-parser';
import { getBreadcrumbs, EXCLUDED_PAGES } from '../../utils/categories';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const PROJECT_NAME = 'tomohirotsuji-plants';
  const response = await fetch(`https://scrapbox.io/api/pages/${PROJECT_NAME}`);
  const data = await response.json();

  const titleToId = Object.fromEntries(data.pages.map((page) => [page.title, page.id]));
  const titleToImage = Object.fromEntries(
    data.pages.filter((page) => page.image).map((page) => [page.title, page.image])
  );

  return data.pages
    .filter((page) => !EXCLUDED_PAGES.has(page.title))
    .map((page) => ({
      params: { id: page.id },
      props: { title: page.title, titleToId, titleToImage },
    }));
}

const { id } = Astro.params;
const { title, titleToId, titleToImage } = Astro.props;
const PROJECT_NAME = 'tomohirotsuji-plants';

const response = await fetch(`https://scrapbox.io/api/pages/${PROJECT_NAME}/${encodeURIComponent(title)}`);
const pageData = await response.json();

const parsedContent = pageData.lines ? parseScrapboxContent(pageData.lines.slice(1), titleToId, titleToImage) : [];

const breadcrumbs = getBreadcrumbs(title, titleToId);
---

<Layout title={`${pageData.title || 'Tomo at plants.'} - Tomo at plants.`}>
  {breadcrumbs.length > 0 ? (
    <nav class="breadcrumb">
      {breadcrumbs.map((crumb, i) => (
        <>
          {i > 0 && <span class="sep">›</span>}
          {crumb.href
            ? <a href={crumb.href}>{crumb.label}</a>
            : <span class="current">{crumb.label}</span>
          }
        </>
      ))}
    </nav>
  ) : (
    <a href="/" class="back-link">← 一覧に戻る</a>
  )}
  <h1>{pageData.title}</h1>
  <div class="content">
    {parsedContent.map((item) => (
      <Fragment set:html={item.html} />
    ))}
  </div>
  {pageData.created && (
    <div class="meta">
      <p>作成日: {new Date(pageData.created * 1000).toLocaleDateString('ja-JP')}</p>
      <p>更新日: {new Date(pageData.updated * 1000).toLocaleDateString('ja-JP')}</p>
    </div>
  )}
</Layout>
