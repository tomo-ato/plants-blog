---
import { parseScrapboxContent, extractTagsFromLines } from '../../utils/scrapbox-parser';
import { getBreadcrumbs, getCategory, EXCLUDED_PAGES } from '../../utils/categories';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const PROJECT_NAME = 'tomohirotsuji-plants';
  const response = await fetch(`https://scrapbox.io/api/pages/${PROJECT_NAME}`);
  const data = await response.json();

  const titleToId = Object.fromEntries(data.pages.map((page) => [page.title, page.id.slice(0, 8)]));
  const titleToImage = Object.fromEntries(
    data.pages.filter((page) => page.image).map((page) => [page.title, page.image])
  );

  return data.pages
    .filter((page) => !EXCLUDED_PAGES.has(page.title))
    .map((page) => ({
      params: { id: page.id.slice(0, 8) },
      props: { title: page.title, titleToId, titleToImage },
    }));
}

const { id } = Astro.params;
const { title, titleToId, titleToImage } = Astro.props;
const PROJECT_NAME = 'tomohirotsuji-plants';

const response = await fetch(`https://scrapbox.io/api/pages/${PROJECT_NAME}/${encodeURIComponent(title)}`);
const pageData = await response.json();

const rawLines = pageData.lines ? pageData.lines.slice(1) : [];
const { tags, contentLines } = extractTagsFromLines(rawLines);
const parsedContent = parseScrapboxContent(contentLines, titleToId, titleToImage);

const breadcrumbs = getBreadcrumbs(title, titleToId);

const GENUS_LABELS: Record<string, string> = {
  tillandsia: 'Tillandsia',
  oxalis: 'Oxalis',
  lepanthes: 'Lepanthes',
  avonia: 'Avonia',
  article: 'Article',
};
const { genus } = getCategory(title);
const categoryLabel = genus ? (GENUS_LABELS[genus] ?? null) : null;
---

<Layout title={`${pageData.title || 'Tomo at plants.'} - Tomo at plants.`}>
  {breadcrumbs.length > 0 ? (
    <nav class="breadcrumb">
      {breadcrumbs.map((crumb, i) => (
        <>
          {i > 0 && <span class="sep">›</span>}
          {crumb.href
            ? <a href={crumb.href}>{crumb.label}</a>
            : <span class="current">{crumb.label}</span>
          }
        </>
      ))}
    </nav>
  ) : (
    <a href="/" class="back-link">← 一覧に戻る</a>
  )}
  <h1>{pageData.title}</h1>
  <div class="page-title-meta">
    <div class="meta-row">
      {categoryLabel && (
        <span class={`page-category cat-${genus}`}>{categoryLabel}</span>
      )}
      {pageData.created && (
        <>
          <span class="meta-date">作成: {new Date(pageData.created * 1000).toLocaleDateString('ja-JP')}</span>
          <span class="meta-date">更新: {new Date(pageData.updated * 1000).toLocaleDateString('ja-JP')}</span>
        </>
      )}
    </div>
    {tags.length > 0 && (
      <div class="meta-tags">
        {tags.map(tag => (
          <a href={`/tag?q=${encodeURIComponent(tag)}`} class="tag-chip">#{tag}</a>
        ))}
      </div>
    )}
  </div>
  <div class="content">
    {parsedContent.map((item) => (
      <Fragment set:html={item.html} />
    ))}
  </div>
</Layout>

<style>
  /* h1のborder-bottomを無効化してpage-title-metaに移す */
  h1 {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 8px;
  }
  .page-title-meta {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding-bottom: 12px;
    margin-bottom: 30px;
    border-bottom: 2px solid #ccc;
  }
  .meta-row {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  .meta-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .page-category {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.72em;
    font-weight: 700;
    letter-spacing: 0.03em;
  }
  .cat-tillandsia { background: #e6f4ea; color: #2d7a47; }
  .cat-oxalis     { background: #f2e8fb; color: #7b33c0; }
  .cat-lepanthes  { background: #fff3e0; color: #c86000; }
  .cat-avonia     { background: #fde8ec; color: #c0294a; }
  .cat-article    { background: #e3f0fd; color: #1a5fad; }
  .meta-date {
    font-size: 0.78em;
    color: #999;
  }
  .tag-chip {
    background: #f5f5f5;
    color: #666;
    padding: 3px 10px;
    border-radius: 3px;
    font-size: 0.82em;
    text-decoration: none;
  }
  .tag-chip:hover {
    background: #e8e8e8;
    color: #333;
  }
</style>
