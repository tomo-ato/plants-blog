---
// タグページ：ビルド時生成の /tag-index.json を参照（CORS回避）
import SiteNav from '../../components/SiteNav.astro';
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>タグ検索 - Tomo at plants.</title>
    <style>
      body {
        font-family: 'Noto Sans JP', sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.8;
      }
      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #0066cc;
        text-decoration: none;
      }
      h1 {
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }
      .tag-label {
        display: inline-block;
        background: #f5f5f5;
        color: #666;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 1.1em;
      }
      .page-list {
        list-style: none;
        padding: 0;
        margin-top: 20px;
      }
      .page-list li {
        border-bottom: 1px solid #eee;
        padding: 12px 0;
      }
      .page-list a {
        color: #0066cc;
        text-decoration: none;
        font-size: 1.05em;
      }
      .page-list a:hover {
        text-decoration: underline;
      }
      #status {
        color: #666;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <SiteNav />
    <a href="/" class="back-link">← 一覧に戻る</a>
    <h1 id="tag-heading">タグ検索</h1>
    <div id="status">読み込み中...</div>
    <ul class="page-list" id="page-list"></ul>

    <script>
      async function main() {
        const params = new URLSearchParams(location.search);
        const tag = params.get('q') || '';
        if (!tag) {
          document.getElementById('status').textContent = 'タグが指定されていません';
          return;
        }

        document.title = `${tag} - 植物管理ブログ`;
        document.getElementById('tag-heading').innerHTML =
          `<span class="tag-label">${tag}</span> のページ一覧`;

        try {
          // 同一オリジンのJSONを参照（CORSなし）
          const res = await fetch('/tag-index.json');
          if (!res.ok) {
            document.getElementById('status').textContent =
              'タグインデックスが見つかりません。npm run sync-tags を実行してください';
            return;
          }
          const tagIndex = await res.json();
          const pages = tagIndex[tag] || [];

          const status = document.getElementById('status');
          const list = document.getElementById('page-list');

          if (pages.length === 0) {
            status.textContent = '該当するページが見つかりませんでした';
            return;
          }

          status.textContent = `${pages.length}件のページが見つかりました`;
          list.innerHTML = pages
            .map((p) => `<li><a href="/page/${p.id}">${p.title}</a></li>`)
            .join('');
        } catch {
          document.getElementById('status').textContent = '読み込みに失敗しました';
        }
      }

      main();
    </script>
  </body>
</html>
