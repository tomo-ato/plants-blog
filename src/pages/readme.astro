---
import { parseScrapboxContent } from '../utils/scrapbox-parser';
import Layout from '../layouts/Layout.astro';

const PROJECT_NAME = 'tomohirotsuji-plants';
const PAGE_TITLE = 'READ ME';

const [listRes, pageRes] = await Promise.all([
  fetch(`https://scrapbox.io/api/pages/${PROJECT_NAME}`),
  fetch(`https://scrapbox.io/api/pages/${PROJECT_NAME}/${encodeURIComponent(PAGE_TITLE)}`),
]);
const listData = await listRes.json();
const pageData = await pageRes.json();

const titleToId = Object.fromEntries(listData.pages.map((p) => [p.title, p.id]));
const titleToImage = Object.fromEntries(
  listData.pages.filter((p) => p.image).map((p) => [p.title, p.image])
);

const parsedContent = pageData.lines
  ? parseScrapboxContent(pageData.lines.slice(1), titleToId, titleToImage)
  : [];
---

<Layout title="READ ME - Tomo at plants.">
  <nav class="breadcrumb">
    <a href="/">トップ</a>
    <span class="sep">›</span>
    <span class="current">READ ME</span>
  </nav>
  <h1>READ ME</h1>
  <div class="content">
    {parsedContent.map((item) => (
      <Fragment set:html={item.html} />
    ))}
  </div>
</Layout>
