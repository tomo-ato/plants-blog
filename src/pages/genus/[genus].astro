---
import { getCategory, TILLANDSIA_PARENTS, EXCLUDED_PAGES } from '../../utils/categories.js';
import SiteNav from '../../components/SiteNav.astro';

export async function getStaticPaths() {
  const PROJECT_NAME = 'tomohirotsuji-plants';
  const response = await fetch(`https://scrapbox.io/api/pages/${PROJECT_NAME}`);
  const data = await response.json();
  const allPages = data.pages.filter((p) => !EXCLUDED_PAGES.has(p.title));

  const genera = ['tillandsia', 'oxalis', 'lepanthes', 'avonia'];
  return genera.map((genus) => {
    const pages = allPages.filter((p) => getCategory(p.title).genus === genus);
    return { params: { genus }, props: { pages } };
  });
}

const { genus } = Astro.params;
const { pages } = Astro.props;

const genusLabels = {
  tillandsia: 'Tillandsia',
  oxalis: 'Oxalis',
  lepanthes: 'Lepanthes',
  avonia: 'Avonia',
};
const genusLabel = genusLabels[genus] || genus;

// Tillandsia: 親種ごとにグループ化
const groups = [];
if (genus === 'tillandsia') {
  for (const parent of TILLANDSIA_PARENTS) {
    const parentPage = pages.find((p) => p.title === parent.title);
    const children = pages
      .filter(
        (p) =>
          p.title !== parent.title &&
          parent.prefixes.some((prefix) => p.title.startsWith(prefix))
      )
      .sort((a, b) => a.title.localeCompare(b.title));
    if (parentPage || children.length > 0) {
      groups.push({ parent: parentPage, children });
    }
  }
}

// 他属: A-Z ソート
const sortedPages =
  genus !== 'tillandsia'
    ? [...pages].sort((a, b) => a.title.localeCompare(b.title))
    : [];
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{genusLabel} - Tomo at plants.</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.8;
      }
      nav.breadcrumb {
        font-size: 0.85em;
        color: #999;
        margin-bottom: 20px;
      }
      nav.breadcrumb a {
        color: #0066cc;
        text-decoration: none;
      }
      nav.breadcrumb a:hover {
        text-decoration: underline;
      }
      nav.breadcrumb .sep {
        margin: 0 6px;
        color: #ccc;
      }
      h1 {
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }
      section {
        margin-bottom: 30px;
      }
      h2 {
        font-size: 1.05em;
        margin-bottom: 6px;
        padding-bottom: 4px;
        border-bottom: 1px solid #ddd;
      }
      h2 a {
        color: #333;
        text-decoration: none;
      }
      h2 a:hover {
        text-decoration: underline;
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      li {
        border-bottom: 1px solid #eee;
        padding: 8px 0;
      }
      li.child {
        padding-left: 20px;
      }
      li a {
        color: #0066cc;
        text-decoration: none;
      }
      li a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <SiteNav />
    <nav class="breadcrumb">
      <a href="/">トップ</a>
      <span class="sep">›</span>
      <span>{genusLabel}</span>
    </nav>
    <h1>{genusLabel}</h1>

    {genus === 'tillandsia' && groups.map((group) => (
      <section>
        <h2>
          {group.parent
            ? <a href={`/page/${group.parent.id}`}>{group.parent.title}</a>
            : <span>その他</span>
          }
        </h2>
        <ul>
          {group.children.map((p) => (
            <li class="child"><a href={`/page/${p.id}`}>{p.title}</a></li>
          ))}
        </ul>
      </section>
    ))}

    {genus !== 'tillandsia' && (
      <ul>
        {sortedPages.map((p) => (
          <li><a href={`/page/${p.id}`}>{p.title}</a></li>
        ))}
      </ul>
    )}
  </body>
</html>
